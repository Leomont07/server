deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      # ... (Pasos de Copia de Archivos de Nginx y Script) ...

      # Ejecutar el script Blue-Green
      - name: Ejecutar Despliegue Blue-Green
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. INICIO DE SESIÓN EN GHCR EN EL SERVIDOR EC2
            echo "Iniciando sesión en GHCR en el servidor..."
            # Usamos el token de GitHub para autenticar el 'docker pull'
            echo "${{ secrets.CR_TOKEN }}" | docker login ghcr.io \
              --username ${{ secrets.CR_USERNAME }} \
              --password-stdin
            
            # 2. EJECUCIÓN DEL SCRIPT
            export GITHUB_REPOSITORY=${{ github.repository }}
            /home/${{ secrets.SSH_USER }}/app/deploy_blue_green.sh ${{ env.VERSION_TAG }}
            
            # 3. Limpiar el login (Opcional, pero buena práctica)
            docker logout ghcr.io